<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quote Kiosk - V3.0 (Smart Config)</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f5f7; }
        .kiosk-container { max-width: 800px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* -- Header & Tabs -- */
        h2 { margin-top: 0; color: #333; }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; font-size: 16px; cursor: pointer; background: #e9ecef; border: none; border-radius: 5px; font-weight: bold; color: #555; transition: 0.3s; }
        .tab-btn.active { background: #007bff; color: white; }

        /* -- System Messages -- */
        .system-alert { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; border: 1px solid #ffeeba; margin-bottom: 15px; display:none; font-size: 14px;}

        /* -- Search & Inputs -- */
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* -- Search Results Dropdown -- */
        #results { border: 1px solid #ddd; max-height: 250px; overflow-y: auto; display: none; background: #fff; position: absolute; width: calc(100% - 90px); z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-item:hover { background-color: #f0f8ff; }

        /* -- Qty Selection -- */
        #qtySection { display: none; background: #e3f2fd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #90caf9; }
        
        /* -- Tables -- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: #666; font-size: 14px; text-transform: uppercase; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 15px; }
        
        /* -- Questions Section -- */
        .questions-box { background: #e9ecef; border: 1px solid #ced4da; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .checkbox-group { display: flex; gap: 20px; align-items: center; margin-top: 5px; }
        .checkbox-group label { font-size: 16px; cursor: pointer; display: flex; align-items: center; }
        .checkbox-group input { width: 20px; height: 20px; margin-right: 10px; }

        /* -- Action Buttons -- */
        .action-bar { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-action { padding: 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; flex: 1; font-weight: bold; }
        .btn-update { background: #17a2b8; color: white; }
        .btn-finish { background: #28a745; color: white; }
        .btn-action:disabled { background: #ccc; cursor: not-allowed; }

        /* -- Existing Items Section -- */
        .existing-section { margin-top: 30px; opacity: 0.8; }
        .existing-section h3 { font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 0; color: #555; }

        /* -- Utilities -- */
        .badge-new { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
        .badge-auto { background: #ffc107; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="kiosk-container">
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Solution Configurator</h2>
        <div id="statusArea" style="font-size:12px; color:#888;">Initializing...</div>
    </div>

    <div id="logicAlert" class="system-alert"></div>

    <div class="filter-tabs">
        <button class="tab-btn active" id="btnPhone" onclick="switchCategory('Phone')">Phones</button>
        <button class="tab-btn" id="btnATA" onclick="switchCategory('ATA')">ATAs</button>
        <button class="tab-btn" id="btnOther" onclick="switchCategory('Other')">Other Hardware</button>
    </div>

    <div style="position: relative;">
        <input type="text" id="searchBox" placeholder="Loading Products..." 
               onfocus="showDropdown()" 
               onkeyup="filterLocalProducts()">
        <div id="results"></div>
    </div>

    <div id="qtySection">
        <h3 id="selectedName" style="margin-top:0;"></h3>
        <label>Quantity:</label>
        <input type="number" id="qtyInput" value="1" min="1" style="width:80px; display:inline-block; margin-right:10px;">
        <button onclick="addToCart()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Add</button>
        <button onclick="cancelSelection()" style="padding:10px; background:none; border:none; color:#666; cursor:pointer; text-decoration:underline;">Cancel</button>
    </div>

    <table id="cartTable">
        <thead>
            <tr>
                <th>Item To Add</th>
                <th width="50">Qty</th>
                <th width="50"></th>
            </tr>
        </thead>
        <tbody id="cartBody">
            <tr><td colspan="3" style="text-align:center; color:#999;">Cart is empty</td></tr>
        </tbody>
    </table>

    <div class="questions-box">
        <strong> Installation Requirements:</strong>
        <div class="checkbox-group">
            <label title="Field: Ethernet_Cabling">
                <input type="checkbox" id="chk_ethernet"> Ethernet Cabling?
            </label>
            <label title="Field: PoE_Available">
                <input type="checkbox" id="chk_poe" onchange="runComplianceCheck()"> PoE Available?
            </label>
        </div>
    </div>

    <div class="action-bar">
        <button id="btnUpdate" class="btn-action btn-update" onclick="submitData('save')" disabled>Update Deal Only</button>
        <button id="btnFinish" class="btn-action btn-finish" onclick="submitData('advance')" disabled>Save & Finish</button>
    </div>

    <div class="existing-section">
        <h3>Current Deal Inventory <span id="loadingInv"></span></h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody id="existingBody"></tbody>
        </table>
    </div>

</div>

<script>
    /* =======================================================
       STATE MANAGEMENT
       ======================================================= */
    let state = {
        dealId: null,
        cart: [],
        existingSubform: [], 
        masterProductList: [], 
        activeCategory: 'Phone',
        
        // System Data for Logic
        defaultPowerSupply: null, // Will hold the product obj for "Power Supply"
        defaultATA: null,         // Will hold the product obj for "ATA"
        
        // Deal Metrics for Logic
        metrics: {
            analogLines: 0,
            pagingQty: 0,
            faxQty: 0,
            e911Locs: 1
        }
    };

    /* =======================================================
       1. INITIALIZATION
       ======================================================= */
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            let id = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            state.dealId = id;
            document.getElementById("statusArea").innerText = "Connected";
            enableButtons(true);
            loadDealData(); 
        }
    });

    ZOHO.embeddedApp.init().then(function(){
        fetchProducts('Phone'); // Load initial list
        fetchSystemHardware();  // Pre-fetch Power Supply & ATA for automation
    });

    /* =======================================================
       2. DATA LOADING
       ======================================================= */
    
    // Fetch "System" products (Power Supply & Default ATA) to have ready for auto-add
    function fetchSystemHardware() {
        ZOHO.CRM.API.getAllRecords({ Entity: "Products", sort_order: "asc", per_page: 200 })
        .then(function(data){
            if(data.data){
                // Find First Power Supply
                state.defaultPowerSupply = data.data.find(p => p.Hardware_Type === "Power Supply");
                // Find First ATA (fallback if user doesn't pick one)
                state.defaultATA = data.data.find(p => p.Category === "ATA");
                
                console.log("System Hardware Loaded:", state.defaultPowerSupply, state.defaultATA);
            }
        });
    }

    // Load Deal Details & Metrics
    function loadDealData() {
        document.getElementById("loadingInv").innerText = "(Loading...)";
        
        ZOHO.CRM.API.getRecord({Entity: "Deals", RecordID: state.dealId})
        .then(function(response){
            let data = response.data[0];
            
            // Checkboxes
            document.getElementById("chk_ethernet").checked = (data.Ethernet_Cabling === "Yes");
            document.getElementById("chk_poe").checked = (data.PoE_Available === "Yes");

            // Logic Metrics (Ensure integers)
            state.metrics.analogLines = parseInt(data.Analog_Line_Count) || 0;
            state.metrics.pagingQty = parseInt(data.POTS_for_Paging_Qty) || 0;
            state.metrics.faxQty = parseInt(data.T_38_Fax) || 0;
            state.metrics.e911Locs = parseInt(data.E911_Locations) || 1; 

            // Existing Subform Items
            state.existingSubform = [];
            if(data.Phone_Hardware) {
                state.existingSubform = data.Phone_Hardware.map(row => ({
                    id: row.id, 
                    product_name: row.Phone_Selection.name,
                    product_id: row.Phone_Selection.id,
                    quantity: parseInt(row.Phone_Qty) || 0,
                    // We need to know if existing items are Phones to calc Power needs
                    // Ideally we'd query product details, but for now we assume they are valid phones
                    isPhone: true 
                }));
            }
            renderExistingItems();
            
            // Run initial check (e.g. if Analog lines exist but no ATA)
            runComplianceCheck(); 
        });
    }

    // Fetch Products based on Tab
    function fetchProducts(type) {
        state.activeCategory = type;
        document.getElementById("searchBox").placeholder = "Loading " + type + "...";
        document.getElementById("searchBox").value = "";
        
        state.masterProductList = [];
        document.getElementById("results").innerHTML = "";

        // STRATEGY:
        // Phones = Criteria Search
        // ATA = Search by Category
        // Other = GetAll + Filter

        if(type === 'Phone') {
            ZOHO.CRM.API.searchRecord({ Entity: "Products", Type: "criteria", Query: "((Hardware_Type:equals:NA))" })
            .then(processResults).catch(handleErr);
        } 
        else if (type === 'ATA') {
             // ATAs are Category based, Hardware Type NA
             ZOHO.CRM.API.getAllRecords({ Entity: "Products", per_page: 200 })
            .then(function(data){
                if(data.data) {
                    state.masterProductList = data.data.filter(p => p.Category === "ATA");
                    updateSearchPlaceholder();
                }
            });
        }
        else {
            // Other Hardware (Exclude NA type, exclude ATA category)
            ZOHO.CRM.API.getAllRecords({ Entity: "Products", per_page: 200 })
            .then(function(data){
                if(data.data) {
                    state.masterProductList = data.data.filter(p => p.Hardware_Type !== "NA" && p.Category !== "ATA");
                    updateSearchPlaceholder();
                }
            });
        }
    }

    function processResults(data) {
        if(data.data){
            // If Phone, ensure Category has 'phone'
            if(state.activeCategory === 'Phone') {
                state.masterProductList = data.data.filter(p => p.Category && p.Category.toLowerCase().includes("phone"));
            } else {
                state.masterProductList = data.data;
            }
            updateSearchPlaceholder();
        } else {
            handleNoResults();
        }
    }

    function handleErr(err) { console.error(err); handleNoResults(); }
    
    function updateSearchPlaceholder() {
        document.getElementById("searchBox").placeholder = "Search " + state.masterProductList.length + " items...";
    }

    function handleNoResults() {
        state.masterProductList = [];
        document.getElementById("searchBox").placeholder = "No products found.";
    }

    /* =======================================================
       3. COMPLIANCE ENGINE (The Logic Brain)
       ======================================================= */
    
    function runComplianceCheck() {
        let alerts = [];
        let didAutoAdd = false;

        // --- A. POWER SUPPLY LOGIC ---
        // 1. Calculate Total Phones (Cart + Existing)
        // We assume Cart items in 'Phone' tab are phones. 
        // Note: We need a way to know if a cart item is a phone. 
        // For simplicity, we check if the name DOES NOT contain "Power" or "ATA"
        
        let cartPhones = state.cart.reduce((sum, item) => {
            let isPower = item.product_name.toLowerCase().includes("power");
            let isATA = item.product_name.toLowerCase().includes("ata"); // Rough check
            return (!isPower && !isATA) ? sum + parseInt(item.quantity) : sum;
        }, 0);

        let existingPhones = state.existingSubform.reduce((sum, item) => sum + item.quantity, 0);
        let totalPhones = cartPhones + existingPhones;

        // 2. Check PoE Status
        let poeAvailable = document.getElementById("chk_poe").checked;
        
        if(!poeAvailable && totalPhones > 0) {
            // WE NEED POWER SUPPLIES
            if(state.defaultPowerSupply) {
                let psuName = state.defaultPowerSupply.Product_Name;
                let psuId = state.defaultPowerSupply.id;

                // Check how many we have in cart
                let cartPSU = state.cart.find(i => i.product_id === psuId);
                let currentPSUQty = cartPSU ? parseInt(cartPSU.quantity) : 0;

                if(currentPSUQty < totalPhones) {
                    // FORCE ADD/UPDATE
                    upsertCartItem(psuId, psuName, totalPhones, true); // true = isAuto
                    alerts.push(`⚠️ PoE Unchecked: Added ${totalPhones} Power Supplies.`);
                    didAutoAdd = true;
                }
            } else {
                alerts.push("⚠️ Error: 'Power Supply' product not found in System.");
            }
        }

        // --- B. ATA LOGIC ---
        let totalLines = state.metrics.analogLines + state.metrics.pagingQty + state.metrics.faxQty;
        
        if(totalLines > 0) {
            // 1. Calculate Needs
            // Rule 1: Capacity (2 ports per ATA)
            let portNeeded = Math.ceil(totalLines / 2);
            
            // Rule 2: Locations (Cannot split 1 ATA across 2 addresses)
            // If E911 > 1, ensure at least 1 ATA per location involved (capped by line count)
            // We assume worst case: lines are spread evenly or max distribution
            let locNeeded = Math.min(totalLines, state.metrics.e911Locs);
            
            let requiredATAs = Math.max(portNeeded, locNeeded);

            // 2. Check Cart for ANY ATA
            // We sum up quantity of ALL items that are likely ATAs (Category ATA)
            // Since we don't store Category in Cart, we cross-reference or assume Name check?
            // BETTER: We rely on the user adding ATAs. If total count is low, we force the DEFAULT ATA.
            
            let currentATAQty = state.cart.reduce((sum, item) => {
                // Determine if item is ATA. 
                // Weak check: Name contains ATA or it matches defaultATA ID
                if(item.product_name.toUpperCase().includes("ATA")) return sum + parseInt(item.quantity);
                return sum;
            }, 0);

            if(currentATAQty < requiredATAs) {
                if(state.defaultATA) {
                    let deficit = requiredATAs - currentATAQty;
                    // We only add the Default ATA to bridge the gap
                    // Find if default ATA is already in cart
                    let cartDefault = state.cart.find(i => i.product_id === state.defaultATA.id);
                    let newQty = (cartDefault ? parseInt(cartDefault.quantity) : 0) + deficit;

                    upsertCartItem(state.defaultATA.id, state.defaultATA.Product_Name, newQty, true);
                    alerts.push(`⚠️ Analog/Fax Lines Detected: Enforced ${requiredATAs} ATA(s).`);
                    didAutoAdd = true;
                } else {
                    alerts.push("⚠️ Error: No 'ATA' category product found in System.");
                }
            }
        }

        // Display Alerts
        let alertBox = document.getElementById("logicAlert");
        if(alerts.length > 0) {
            alertBox.innerText = alerts.join("\n");
            alertBox.style.display = "block";
        } else {
            alertBox.style.display = "none";
        }

        if(didAutoAdd) renderCart();
    }

    function upsertCartItem(id, name, qty, isAuto) {
        let existingIndex = state.cart.findIndex(i => i.product_id === id);
        if(existingIndex > -1) {
            state.cart[existingIndex].quantity = qty;
            if(isAuto) state.cart[existingIndex].isAuto = true;
        } else {
            state.cart.push({
                product_id: id,
                product_name: name,
                quantity: qty,
                isAuto: isAuto || false
            });
        }
    }

    /* =======================================================
       4. UI INTERACTION
       ======================================================= */
    
    function switchCategory(type) {
        document.getElementById("btnPhone").className = type === 'Phone' ? 'tab-btn active' : 'tab-btn';
        document.getElementById("btnATA").className = type === 'ATA' ? 'tab-btn active' : 'tab-btn';
        document.getElementById("btnOther").className = type === 'Other' ? 'tab-btn active' : 'tab-btn';
        fetchProducts(type);
    }

    function showDropdown() { renderDropdown(state.masterProductList); }

    function filterLocalProducts() {
        let q = document.getElementById("searchBox").value.toLowerCase();
        let filtered = state.masterProductList.filter(p => p.Product_Name.toLowerCase().includes(q));
        renderDropdown(filtered);
    }

    function renderDropdown(items) {
        let html = "";
        if(items.length === 0) html = "<div class='result-item'>No matches</div>";
        else {
            items.forEach(p => {
                html += `<div class='result-item' onclick='selectProduct("${p.id}", "${p.Product_Name.replace(/"/g, '&quot;')}")'>${p.Product_Name}</div>`;
            });
        }
        document.getElementById("results").innerHTML = html;
        document.getElementById("results").style.display = "block";
    }

    let selectedItem = null;
    function selectProduct(id, name) {
        selectedItem = {id: id, name: name};
        document.getElementById("results").style.display = "none";
        document.getElementById("qtySection").style.display = "block";
        document.getElementById("selectedName").innerText = name;
        document.getElementById("qtyInput").focus();
    }

    function addToCart() {
        let qty = parseInt(document.getElementById("qtyInput").value);
        if(qty > 0) {
            upsertCartItem(selectedItem.id, selectedItem.name, qty, false);
            renderCart();
            cancelSelection();
            document.getElementById("searchBox").value = "";
            
            // RUN RULES AFTER ADD
            runComplianceCheck();
        }
    }

    function cancelSelection() {
        document.getElementById("qtySection").style.display = "none";
        selectedItem = null;
    }

    function renderCart() {
        let tbody = document.getElementById("cartBody");
        if(state.cart.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#999;'>Cart is empty</td></tr>";
            return;
        }
        let html = "";
        state.cart.forEach((item, index) => {
            let badge = item.isAuto ? `<span class="badge-auto">Required</span>` : `<span class="badge-new">New</span>`;
            html += `<tr>
                <td>${item.product_name} ${badge}</td>
                <td>${item.quantity}</td>
                <td><button onclick="removeFromCart(${index})" style="color:red; background:none; border:none; cursor:pointer;">X</button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function removeFromCart(index) {
        state.cart.splice(index, 1);
        renderCart();
        // RUN RULES AFTER REMOVE (If they remove Power Supply, it might immediately add back!)
        runComplianceCheck();
    }

    function renderExistingItems() {
        let tbody = document.getElementById("existingBody");
        document.getElementById("loadingInv").innerText = "";
        if(state.existingSubform.length === 0) {
            tbody.innerHTML = "<tr><td colspan='2' style='color:#999;'>No items on Deal yet.</td></tr>";
            return;
        }
        let html = "";
        state.existingSubform.forEach(item => {
            html += `<tr><td>${item.product_name}</td><td>${item.quantity}</td></tr>`;
        });
        tbody.innerHTML = html;
    }

    /* =======================================================
       5. SUBMISSION LOGIC
       ======================================================= */
    
    function submitData(mode) {
        if(mode === 'advance' && state.cart.length === 0 && state.existingSubform.length === 0) {
            if(!confirm("The deal has no hardware. Are you sure you want to proceed?")) return;
        }

        setLoading(true, mode);

        let ethVal = document.getElementById("chk_ethernet").checked ? "Yes" : null;
        let poeVal = document.getElementById("chk_poe").checked ? "Yes" : null;

        let subformData = [];
        
        // Preserve Existing
        state.existingSubform.forEach(row => {
            subformData.push({ "id": row.id.toString() });
        });

        // Add New
        state.cart.forEach(item => {
            subformData.push({
                "Phone_Selection": { "id": item.product_id },
                "Phone_Qty": item.quantity
            });
        });

        let payload = {
            "id": state.dealId,
            "Ethernet_Cabling": ethVal,
            "PoE_Available": poeVal,
            "Phone_Hardware": subformData
        };

        ZOHO.CRM.API.updateRecord({ Entity: "Deals", APIData: payload, Trigger: ["workflow"] })
        .then(function(data){
            if(mode === 'advance') {
                ZOHO.CRM.BLUEPRINT.proceed({ action: "save", data: {} });
            } else {
                state.cart = []; 
                renderCart();
                loadDealData(); 
                setLoading(false, mode);
                document.getElementById("logicAlert").style.display = "none"; // Clear alerts
                alert("Deal Updated Successfully");
            }
        })
        .catch(function(err){
            alert("Error: " + JSON.stringify(err));
            setLoading(false, mode);
        });
    }

    function enableButtons(enabled) {
        document.getElementById("btnUpdate").disabled = !enabled;
        document.getElementById("btnFinish").disabled = !enabled;
    }

    function setLoading(isLoading, mode) {
        let btn = (mode === 'save') ? document.getElementById("btnUpdate") : document.getElementById("btnFinish");
        if(isLoading) {
            btn.innerText = "Processing...";
            enableButtons(false);
        } else {
            document.getElementById("btnUpdate").innerText = "Update Deal Only";
            document.getElementById("btnFinish").innerText = "Save & Finish";
            enableButtons(true);
        }
    }

</script>

</body>
</html>
