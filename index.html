<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quote Kiosk - V4.1 (Strict Type Logic)</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f5f7; }
        .kiosk-container { max-width: 850px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* -- Header -- */
        h2 { margin-top: 0; color: #333; }
        .header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; }
        
        /* -- Logic Dashboard -- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .dash-card { padding: 15px; border-radius: 6px; border-left: 5px solid #ccc; background: #f9f9f9; }
        .dash-card.error { border-left-color: #dc3545; background: #fff5f5; }
        .dash-card.success { border-left-color: #28a745; background: #f0fff4; }
        .dash-title { font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; color: #555; }
        .dash-stat { font-size: 13px; color: #666; }
        
        /* -- Override Section -- */
        #overrideSection { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: none; }
        #overrideSection label { font-weight: bold; cursor: pointer; }

        /* -- Tabs -- */
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 15px; cursor: pointer; background: #e9ecef; border: none; border-radius: 5px; font-weight: bold; color: #555; transition: 0.3s; }
        .tab-btn.active { background: #007bff; color: white; }

        /* -- Inputs -- */
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; font-size: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* -- Search Results -- */
        #results { border: 1px solid #ddd; max-height: 250px; overflow-y: auto; display: none; background: #fff; position: absolute; width: calc(100% - 90px); z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-item:hover { background-color: #f0f8ff; }

        /* -- Qty Selection -- */
        #qtySection { display: none; background: #e3f2fd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #90caf9; }
        
        /* -- Tables -- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: #666; font-size: 13px; text-transform: uppercase; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; }
        .btn-del { color: #dc3545; background: none; border: 1px solid #dc3545; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 12px; }
        .btn-del:hover { background: #dc3545; color: white; }
        
        /* -- Requirements -- */
        .questions-box { background: #e9ecef; border: 1px solid #ced4da; padding: 10px; border-radius: 5px; margin: 20px 0; display:flex; gap: 20px; align-items: center;}
        .questions-box label { cursor: pointer; font-weight: 500; }

        /* -- Action Bar -- */
        .action-bar { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-action { padding: 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; flex: 1; font-weight: bold; }
        .btn-update { background: #17a2b8; color: white; }
        .btn-finish { background: #28a745; color: white; }
        .btn-action:disabled { background: #ccc; cursor: not-allowed; }
        
        .badge-new { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
        .badge-old { background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="kiosk-container">
    
    <div class="header-row">
        <h2>Solution Configurator</h2>
        <div id="statusArea" style="font-size:12px; color:#888;">Initializing...</div>
    </div>

    <div class="dashboard">
        <div class="dash-card" id="cardPower">
            <span class="dash-title">üîå Power Supply Check</span>
            <div class="dash-stat" id="statPower">Calculating...</div>
        </div>
        <div class="dash-card" id="cardATA">
            <span class="dash-title">üìü ATA / Analog Check</span>
            <div class="dash-stat" id="statATA">Calculating...</div>
        </div>
    </div>

    <div id="overrideSection">
        <label>
            <input type="checkbox" id="chkOverride" onchange="toggleSaveButtons()"> 
            ‚ö†Ô∏è I certify that I have verified the hardware quantities manually. (Override Warnings)
        </label>
    </div>

    <div class="filter-tabs">
        <button class="tab-btn active" id="btnPhone" onclick="switchCategory('Phone')">Phones</button>
        <button class="tab-btn" id="btnATA" onclick="switchCategory('ATA')">ATAs</button>
        <button class="tab-btn" id="btnOther" onclick="switchCategory('Other')">Other Hardware</button>
    </div>

    <div style="position: relative;">
        <input type="text" id="searchBox" placeholder="Loading Products..." 
               onfocus="showDropdown()" 
               onkeyup="filterLocalProducts()">
        <div id="results"></div>
    </div>

    <div id="qtySection">
        <h3 id="selectedName" style="margin-top:0;"></h3>
        <label>Quantity:</label>
        <input type="number" id="qtyInput" value="1" min="1" style="width:80px; display:inline-block; margin-right:10px;">
        <button onclick="addToCart()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Add</button>
        <button onclick="cancelSelection()" style="padding:10px; background:none; border:none; color:#666; cursor:pointer; text-decoration:underline;">Cancel</button>
    </div>

    <h3 style="margin-bottom:5px; color:#555;">Inventory Configuration</h3>
    <table id="mainTable">
        <thead>
            <tr>
                <th>Product</th>
                <th width="80">Qty</th>
                <th width="80">Action</th>
            </tr>
        </thead>
        <tbody id="inventoryBody">
            <tr><td colspan="3" style="text-align:center; color:#999;">Loading...</td></tr>
        </tbody>
    </table>

    <div class="questions-box">
        <strong> Settings:</strong>
        <label title="Field: Ethernet_Cabling">
            <input type="checkbox" id="chk_ethernet"> Ethernet Cabling
        </label>
        <label title="Field: PoE_Available">
            <input type="checkbox" id="chk_poe" onchange="runComplianceCheck()"> PoE Available
        </label>
    </div>

    <div class="action-bar">
        <button id="btnUpdate" class="btn-action btn-update" onclick="submitData('save')" disabled>Update Deal Only</button>
        <button id="btnFinish" class="btn-action btn-finish" onclick="submitData('advance')" disabled>Save & Finish</button>
    </div>

</div>

<script>
    /* =======================================================
       STATE MANAGEMENT
       ======================================================= */
    let state = {
        dealId: null,
        
        // Lists
        existingSubform: [], 
        cart: [], 
        deletedIds: [], 
        
        masterProductList: [], 
        activeCategory: 'Phone',

        // Whitelists (IDs) for Strict Type Checking
        validPowerIDs: [],
        validATAIDs: [],
        referenceLoaded: false,
        
        // Compliance Flags
        isPowerCompliant: true,
        isATACompliant: true,

        // Metrics
        metrics: {
            analogLines: 0,
            pagingQty: 0,
            faxQty: 0,
            e911Locs: 1
        }
    };

    /* =======================================================
       1. INITIALIZATION
       ======================================================= */
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            let id = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            state.dealId = id;
            document.getElementById("statusArea").innerText = "Connected";
            loadDealData(); 
        }
    });

    ZOHO.embeddedApp.init().then(function(){
        fetchProducts('Phone'); 
        fetchReferenceData(); // Load Whitelists
    });

    /* =======================================================
       2. DATA LOADING
       ======================================================= */
    
    // FETCH WHITELISTS (Strict Logic Source)
    function fetchReferenceData() {
        // Fetch ALL products (limit 200) to find official Power Cords & ATAs
        ZOHO.CRM.API.getAllRecords({ Entity: "Products", per_page: 200 })
        .then(function(data){
            if(data.data) {
                data.data.forEach(p => {
                    // STRICT CHECK 1: Power Cords
                    if(p.Hardware_Type === "Power Cords") {
                        state.validPowerIDs.push(p.id);
                    }
                    // STRICT CHECK 2: ATAs
                    if(p.Category === "ATA") {
                        state.validATAIDs.push(p.id);
                    }
                });
                state.referenceLoaded = true;
                console.log("Reference Data Loaded. Cords:", state.validPowerIDs.length, "ATAs:", state.validATAIDs.length);
                runComplianceCheck(); // Re-run in case Deal loaded first
            }
        });
    }

    function loadDealData() {
        ZOHO.CRM.API.getRecord({Entity: "Deals", RecordID: state.dealId})
        .then(function(response){
            let data = response.data[0];
            
            document.getElementById("chk_ethernet").checked = (data.Ethernet_Cabling === "Yes");
            document.getElementById("chk_poe").checked = (data.PoE_Available === "Yes");

            state.metrics.analogLines = parseInt(data.Analog_Line_Count) || 0;
            state.metrics.pagingQty = parseInt(data.POTS_for_Paging_Qty) || 0;
            state.metrics.faxQty = parseInt(data.T_38_Fax) || 0;
            state.metrics.e911Locs = parseInt(data.E911_Locations) || 1; 

            state.existingSubform = [];
            state.deletedIds = []; 
            
            if(data.Phone_Hardware) {
                state.existingSubform = data.Phone_Hardware.map(row => ({
                    row_id: row.id, 
                    product_name: row.Phone_Selection.name,
                    product_id: row.Phone_Selection.id,
                    quantity: parseInt(row.Phone_Qty) || 0,
                    source: 'existing'
                }));
            }
            
            renderInventory();
            runComplianceCheck(); 
        });
    }

    function fetchProducts(type) {
        state.activeCategory = type;
        document.getElementById("searchBox").placeholder = "Loading " + type + "...";
        document.getElementById("searchBox").value = "";
        state.masterProductList = [];
        document.getElementById("results").innerHTML = "";

        if(type === 'Phone') {
            ZOHO.CRM.API.searchRecord({ Entity: "Products", Type: "criteria", Query: "((Hardware_Type:equals:NA))" })
            .then(processResults).catch(handleErr);
        } 
        else if (type === 'ATA') {
             // We can use the reference list if fully loaded, but Search is safer for partial loads
             ZOHO.CRM.API.getAllRecords({ Entity: "Products", per_page: 200 })
            .then(function(data){
                if(data.data) {
                    state.masterProductList = data.data.filter(p => p.Category === "ATA");
                    updateSearchPlaceholder();
                }
            });
        }
        else {
            ZOHO.CRM.API.getAllRecords({ Entity: "Products", per_page: 200 })
            .then(function(data){
                if(data.data) {
                    state.masterProductList = data.data.filter(p => p.Hardware_Type !== "NA" && p.Category !== "ATA");
                    updateSearchPlaceholder();
                }
            });
        }
    }

    function processResults(data) {
        if(data.data){
            if(state.activeCategory === 'Phone') {
                state.masterProductList = data.data.filter(p => p.Category && p.Category.toLowerCase().includes("phone"));
            } else {
                state.masterProductList = data.data;
            }
            updateSearchPlaceholder();
        } else {
            handleNoResults();
        }
    }
    function handleErr(err) { console.error(err); handleNoResults(); }
    function updateSearchPlaceholder() { document.getElementById("searchBox").placeholder = "Search " + state.masterProductList.length + " items..."; }
    function handleNoResults() { state.masterProductList = []; document.getElementById("searchBox").placeholder = "No products found."; }

    /* =======================================================
       3. LOGIC ENGINE (STRICT ID MATCHING)
       ======================================================= */
    
    function runComplianceCheck() {
        if(!state.referenceLoaded) {
            document.getElementById("statPower").innerText = "Loading Reference Data...";
            return; 
        }

        let allItems = getAllActiveItems(); 
        
        // --- 1. CLASSIFY ITEMS BY ID ---
        let countPhones = 0; 
        let countCords = 0;
        let countATAs = 0;

        allItems.forEach(item => {
            if(state.validPowerIDs.includes(item.product_id)) {
                countCords += item.quantity;
            }
            else if(state.validATAIDs.includes(item.product_id)) {
                countATAs += item.quantity;
            }
            else {
                // Assumption: If it's not a known Power Cord or ATA, it's a Phone/Device
                countPhones += item.quantity;
            }
        });

        // --- 2. POWER CHECK ---
        let poe = document.getElementById("chk_poe").checked;
        let pCard = document.getElementById("cardPower");
        let pStat = document.getElementById("statPower");
        
        if(!poe && countPhones > 0) {
            if(countCords < countPhones) {
                state.isPowerCompliant = false;
                pCard.className = "dash-card error";
                pStat.innerHTML = `‚ö†Ô∏è <b>Mismatch:</b> ${countPhones} Phones vs ${countCords} Valid Cords.<br>Type "Power Cords" required.`;
            } else {
                state.isPowerCompliant = true;
                pCard.className = "dash-card success";
                pStat.innerHTML = `‚úÖ <b>OK:</b> ${countPhones} Phones, ${countCords} Cords.`;
            }
        } else {
            state.isPowerCompliant = true;
            pCard.className = "dash-card success";
            pStat.innerHTML = poe ? `‚úÖ <b>OK:</b> PoE is Available.` : `‚úÖ <b>OK:</b> No phones configured.`;
        }

        // --- 3. ATA CHECK ---
        let totalLines = state.metrics.analogLines + state.metrics.pagingQty + state.metrics.faxQty;
        let aCard = document.getElementById("cardATA");
        let aStat = document.getElementById("statATA");

        if(totalLines > 0) {
            let estPorts = Math.ceil(totalLines / 2);
            let locs = state.metrics.e911Locs;
            let minDevices = Math.max(estPorts, locs);

            if(countATAs < minDevices) {
                state.isATACompliant = false;
                aCard.className = "dash-card error";
                aStat.innerHTML = `‚ö†Ô∏è <b>Check Required:</b><br>${totalLines} Analog Lines / ${locs} Locs.<br>Est. Requirement: ~${minDevices} ATAs.<br>Current Count: ${countATAs}.`;
            } else {
                state.isATACompliant = true;
                aCard.className = "dash-card success";
                aStat.innerHTML = `‚úÖ <b>OK:</b> ${totalLines} Lines covered by ${countATAs} ATAs.`;
            }
        } else {
            state.isATACompliant = true;
            aCard.className = "dash-card success";
            aStat.innerHTML = `‚úÖ <b>OK:</b> No Analog lines detected.`;
        }

        toggleSaveButtons();
    }

    function toggleSaveButtons() {
        let isOverride = document.getElementById("chkOverride").checked;
        let isClean = state.isPowerCompliant && state.isATACompliant;

        let overrideDiv = document.getElementById("overrideSection");
        let btnUpdate = document.getElementById("btnUpdate");
        let btnFinish = document.getElementById("btnFinish");

        if(isClean) {
            overrideDiv.style.display = "none";
            document.getElementById("chkOverride").checked = false; 
            btnUpdate.disabled = false;
            btnFinish.disabled = false;
        } else {
            overrideDiv.style.display = "block";
            btnUpdate.disabled = !isOverride;
            btnFinish.disabled = !isOverride;
        }
    }

    function getAllActiveItems() {
        let active = [];
        state.existingSubform.forEach(item => {
            if(!state.deletedIds.includes(item.row_id)) {
                active.push(item);
            }
        });
        state.cart.forEach(item => active.push(item));
        return active;
    }

    /* =======================================================
       4. UI & INTERACTION
       ======================================================= */
    
    function switchCategory(type) {
        document.getElementById("btnPhone").className = type === 'Phone' ? 'tab-btn active' : 'tab-btn';
        document.getElementById("btnATA").className = type === 'ATA' ? 'tab-btn active' : 'tab-btn';
        document.getElementById("btnOther").className = type === 'Other' ? 'tab-btn active' : 'tab-btn';
        fetchProducts(type);
    }

    function showDropdown() { renderDropdown(state.masterProductList); }
    function filterLocalProducts() {
        let q = document.getElementById("searchBox").value.toLowerCase();
        renderDropdown(state.masterProductList.filter(p => p.Product_Name.toLowerCase().includes(q)));
    }
    function renderDropdown(items) {
        let html = "";
        if(items.length === 0) html = "<div class='result-item'>No matches</div>";
        else items.forEach(p => { html += `<div class='result-item' onclick='selectProduct("${p.id}", "${p.Product_Name.replace(/"/g, '&quot;')}")'>${p.Product_Name}</div>`; });
        document.getElementById("results").innerHTML = html;
        document.getElementById("results").style.display = "block";
    }

    let selectedItem = null;
    function selectProduct(id, name) {
        selectedItem = {id: id, name: name};
        document.getElementById("results").style.display = "none";
        document.getElementById("qtySection").style.display = "block";
        document.getElementById("selectedName").innerText = name;
        document.getElementById("qtyInput").value = 1; 
        document.getElementById("qtyInput").focus();
    }

    function addToCart() {
        let qty = parseInt(document.getElementById("qtyInput").value);
        if(qty > 0) {
            let existing = state.cart.find(i => i.product_id === selectedItem.id);
            if(existing) existing.quantity += qty;
            else state.cart.push({ product_id: selectedItem.id, product_name: selectedItem.name, quantity: qty, source: 'cart' });
            
            cancelSelection();
            document.getElementById("searchBox").value = "";
            renderInventory();
            runComplianceCheck();
        }
    }
    function cancelSelection() { document.getElementById("qtySection").style.display = "none"; selectedItem = null; }

    /* =======================================================
       5. UNIFIED INVENTORY RENDERING
       ======================================================= */
    function renderInventory() {
        let tbody = document.getElementById("inventoryBody");
        let html = "";
        let hasItems = false;

        state.existingSubform.forEach((item, index) => {
            if(!state.deletedIds.includes(item.row_id)) {
                hasItems = true;
                html += `<tr>
                    <td>${item.product_name} <span class="badge-old">Existing</span></td>
                    <td>${item.quantity}</td>
                    <td><button class="btn-del" onclick="deleteExisting('${item.row_id}')">üóëÔ∏è Delete</button></td>
                </tr>`;
            }
        });

        state.cart.forEach((item, index) => {
            hasItems = true;
            html += `<tr>
                <td>${item.product_name} <span class="badge-new">New</span></td>
                <td>${item.quantity}</td>
                <td><button class="btn-del" onclick="removeFromCart(${index})">X Remove</button></td>
            </tr>`;
        });

        if(!hasItems) html = "<tr><td colspan='3' style='text-align:center; color:#999; padding:20px;'>No items selected.</td></tr>";
        tbody.innerHTML = html;
    }

    function deleteExisting(rowId) {
        if(confirm("Mark this item for deletion?")) {
            state.deletedIds.push(rowId);
            renderInventory();
            runComplianceCheck();
        }
    }

    function removeFromCart(index) {
        state.cart.splice(index, 1);
        renderInventory();
        runComplianceCheck();
    }

    /* =======================================================
       6. SUBMISSION LOGIC (Handle Deletions & Merges)
       ======================================================= */
    
    function submitData(mode) {
        setLoading(true, mode);

        let ethVal = document.getElementById("chk_ethernet").checked ? "Yes" : null;
        let poeVal = document.getElementById("chk_poe").checked ? "Yes" : null;

        let subformData = [];

        state.deletedIds.forEach(id => {
            subformData.push({ "id": id, "_delete": null });
        });

        state.existingSubform.forEach(item => {
            if(!state.deletedIds.includes(item.row_id)) {
                subformData.push({ "id": item.row_id }); 
            }
        });

        state.cart.forEach(item => {
            subformData.push({
                "Phone_Selection": { "id": item.product_id },
                "Phone_Qty": item.quantity
            });
        });

        let payload = {
            "id": state.dealId,
            "Ethernet_Cabling": ethVal,
            "PoE_Available": poeVal,
            "Phone_Hardware": subformData
        };

        ZOHO.CRM.API.updateRecord({ Entity: "Deals", APIData: payload, Trigger: ["workflow"] })
        .then(function(data){
            if(mode === 'advance') {
                ZOHO.CRM.BLUEPRINT.proceed({ action: "save", data: {} });
            } else {
                state.cart = []; 
                loadDealData(); 
                setLoading(false, mode);
                document.getElementById("chkOverride").checked = false;
                alert("Deal Updated Successfully");
            }
        })
        .catch(function(err){
            alert("Error: " + JSON.stringify(err));
            setLoading(false, mode);
        });
    }

    function setLoading(isLoading, mode) {
        let btn = (mode === 'save') ? document.getElementById("btnUpdate") : document.getElementById("btnFinish");
        if(isLoading) {
            btn.innerText = "Processing...";
            document.getElementById("btnUpdate").disabled = true;
            document.getElementById("btnFinish").disabled = true;
        } else {
            document.getElementById("btnUpdate").innerText = "Update Deal Only";
            document.getElementById("btnFinish").innerText = "Save & Finish";
            toggleSaveButtons(); 
        }
    }

</script>

</body>
</html>
