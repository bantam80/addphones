<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quote Kiosk - V2.1</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f5f7; }
        .kiosk-container { max-width: 700px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* -- Header & Tabs -- */
        h2 { margin-top: 0; color: #333; }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; font-size: 16px; cursor: pointer; background: #e9ecef; border: none; border-radius: 5px; font-weight: bold; color: #555; transition: 0.3s; }
        .tab-btn.active { background: #007bff; color: white; }

        /* -- Search & Inputs -- */
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* -- Search Results Dropdown -- */
        #results { border: 1px solid #ddd; max-height: 250px; overflow-y: auto; display: none; background: #fff; position: absolute; width: calc(100% - 90px); z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-item:hover { background-color: #f0f8ff; }

        /* -- Qty Selection -- */
        #qtySection { display: none; background: #e3f2fd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #90caf9; }
        
        /* -- Tables -- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: #666; font-size: 14px; text-transform: uppercase; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 15px; }
        
        /* -- Questions Section -- */
        .questions-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .checkbox-group { display: flex; gap: 20px; align-items: center; margin-top: 5px; }
        .checkbox-group label { font-size: 16px; cursor: pointer; display: flex; align-items: center; }
        .checkbox-group input { width: 20px; height: 20px; margin-right: 10px; }

        /* -- Action Buttons -- */
        .action-bar { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-action { padding: 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; flex: 1; font-weight: bold; }
        .btn-update { background: #17a2b8; color: white; }
        .btn-finish { background: #28a745; color: white; }
        .btn-action:disabled { background: #ccc; cursor: not-allowed; }

        /* -- Existing Items Section -- */
        .existing-section { margin-top: 30px; opacity: 0.8; }
        .existing-section h3 { font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 0; color: #555; }
        .status-tag { font-size: 12px; color: #888; font-style: italic; float: right; }

        /* -- Utilities -- */
        .badge-new { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="kiosk-container">
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Add Hardware</h2>
        <div id="statusArea" style="font-size:12px; color:#888;">Initializing...</div>
    </div>

    <div class="filter-tabs">
        <button class="tab-btn active" id="btnPhone" onclick="switchCategory('Phone')">Phones</button>
        <button class="tab-btn" id="btnOther" onclick="switchCategory('Other')">Other Hardware</button>
    </div>

    <div style="position: relative;">
        <input type="text" id="searchBox" placeholder="Loading Products..." 
               onfocus="showDropdown()" 
               onkeyup="filterLocalProducts()">
        <div id="results"></div>
    </div>

    <div id="qtySection">
        <h3 id="selectedName" style="margin-top:0;"></h3>
        <label>Quantity:</label>
        <input type="number" id="qtyInput" value="1" min="1" style="width:80px; display:inline-block; margin-right:10px;">
        <button onclick="addToCart()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Add</button>
        <button onclick="cancelSelection()" style="padding:10px; background:none; border:none; color:#666; cursor:pointer; text-decoration:underline;">Cancel</button>
    </div>

    <table id="cartTable">
        <thead>
            <tr>
                <th>Item To Add</th>
                <th width="50">Qty</th>
                <th width="50"></th>
            </tr>
        </thead>
        <tbody id="cartBody">
            <tr><td colspan="3" style="text-align:center; color:#999;">Cart is empty</td></tr>
        </tbody>
    </table>

    <div class="questions-box">
        <strong> Installation Requirements:</strong>
        <div class="checkbox-group">
            <label title="Field: Ethernet_Cabling">
                <input type="checkbox" id="chk_ethernet"> Ethernet Cabling?
            </label>
            <label title="Field: PoE_Available">
                <input type="checkbox" id="chk_poe"> PoE Available?
            </label>
        </div>
    </div>

    <div class="action-bar">
        <button id="btnUpdate" class="btn-action btn-update" onclick="submitData('save')" disabled>Update Deal Only</button>
        <button id="btnFinish" class="btn-action btn-finish" onclick="submitData('advance')" disabled>Save & Finish</button>
    </div>

    <div class="existing-section">
        <h3>Current Deal Inventory <span id="loadingInv"></span></h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody id="existingBody"></tbody>
        </table>
    </div>

</div>

<script>
    /* =======================================================
       STATE MANAGEMENT
       ======================================================= */
    let state = {
        dealId: null,
        cart: [],
        existingSubform: [], 
        masterProductList: [], 
        activeCategory: 'Phone' 
    };

    /* =======================================================
       1. INITIALIZATION
       ======================================================= */
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            let id = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            state.dealId = id;
            document.getElementById("statusArea").innerText = "Connected";
            enableButtons(true);
            loadDealData(); 
        }
    });

    ZOHO.embeddedApp.init().then(function(){
        fetchProducts('Phone');
    });

    /* =======================================================
       2. DATA LOADING (Deal & Products)
       ======================================================= */
    
    // A. Load Deal Details
    function loadDealData() {
        document.getElementById("loadingInv").innerText = "(Loading...)";
        
        ZOHO.CRM.API.getRecord({Entity: "Deals", RecordID: state.dealId})
        .then(function(response){
            let data = response.data[0];
            
            document.getElementById("chk_ethernet").checked = (data.Ethernet_Cabling === "Yes");
            document.getElementById("chk_poe").checked = (data.PoE_Available === "Yes");

            state.existingSubform = [];
            if(data.Phone_Hardware) {
                state.existingSubform = data.Phone_Hardware.map(row => ({
                    id: row.id, 
                    product_name: row.Phone_Selection.name,
                    product_id: row.Phone_Selection.id,
                    quantity: row.Phone_Qty
                }));
            }
            renderExistingItems();
        });
    }

    // B. Fetch Products based on Tab
    function fetchProducts(type) {
        state.activeCategory = type;
        document.getElementById("searchBox").placeholder = "Loading " + type + "...";
        document.getElementById("searchBox").value = "";
        
        // --- LOGIC CHANGE HERE ---
        let criteria = "";
        if(type === 'Phone') {
            criteria = "((Hardware_Type:equals:NA))";
        } else {
            // Other Hardware: Type is NOT NA
            criteria = "((Hardware_Type:not_equal:NA))"; 
        }

        ZOHO.CRM.API.searchRecord({
            Entity: "Products", 
            Type: "criteria", 
            Query: criteria
        })
        .then(function(data){
            if(data.data){
                if(type === 'Phone') {
                    // Phone Logic: Must include 'phone' in Category
                    state.masterProductList = data.data.filter(p => p.Category && p.Category.toLowerCase().includes("phone"));
                } else {
                    // Other Hardware Logic: Take EVERYTHING returned by query (Hardware_Type != NA)
                    // No Category filtering applied.
                    state.masterProductList = data.data;
                }
                document.getElementById("searchBox").placeholder = "Search " + state.masterProductList.length + " items...";
            } else {
                state.masterProductList = [];
                document.getElementById("searchBox").placeholder = "No products found.";
            }
        });
    }

    /* =======================================================
       3. UI INTERACTION
       ======================================================= */
    
    function switchCategory(type) {
        document.getElementById("btnPhone").className = type === 'Phone' ? 'tab-btn active' : 'tab-btn';
        document.getElementById("btnOther").className = type === 'Other' ? 'tab-btn active' : 'tab-btn';
        fetchProducts(type);
    }

    function showDropdown() {
        renderDropdown(state.masterProductList);
    }

    function filterLocalProducts() {
        let q = document.getElementById("searchBox").value.toLowerCase();
        let filtered = state.masterProductList.filter(p => p.Product_Name.toLowerCase().includes(q));
        renderDropdown(filtered);
    }

    function renderDropdown(items) {
        let html = "";
        if(items.length === 0) html = "<div class='result-item'>No matches</div>";
        else {
            items.forEach(p => {
                html += `<div class='result-item' onclick='selectProduct("${p.id}", "${p.Product_Name.replace(/"/g, '&quot;')}")'>${p.Product_Name}</div>`;
            });
        }
        document.getElementById("results").innerHTML = html;
        document.getElementById("results").style.display = "block";
    }

    let selectedItem = null;
    function selectProduct(id, name) {
        selectedItem = {id: id, name: name};
        document.getElementById("results").style.display = "none";
        document.getElementById("qtySection").style.display = "block";
        document.getElementById("selectedName").innerText = name;
        document.getElementById("qtyInput").focus();
    }

    function addToCart() {
        let qty = document.getElementById("qtyInput").value;
        state.cart.push({
            product_id: selectedItem.id,
            product_name: selectedItem.name,
            quantity: qty
        });
        
        renderCart();
        cancelSelection();
        document.getElementById("searchBox").value = "";
    }

    function cancelSelection() {
        document.getElementById("qtySection").style.display = "none";
        selectedItem = null;
    }

    function renderCart() {
        let tbody = document.getElementById("cartBody");
        if(state.cart.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#999;'>Cart is empty</td></tr>";
            return;
        }
        let html = "";
        state.cart.forEach((item, index) => {
            html += `<tr>
                <td>${item.product_name} <span class="badge-new">New</span></td>
                <td>${item.quantity}</td>
                <td><button onclick="removeFromCart(${index})" style="color:red; background:none; border:none; cursor:pointer;">X</button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function removeFromCart(index) {
        state.cart.splice(index, 1);
        renderCart();
    }

    function renderExistingItems() {
        let tbody = document.getElementById("existingBody");
        document.getElementById("loadingInv").innerText = "";
        
        if(state.existingSubform.length === 0) {
            tbody.innerHTML = "<tr><td colspan='2' style='color:#999;'>No items on Deal yet.</td></tr>";
            return;
        }
        let html = "";
        state.existingSubform.forEach(item => {
            html += `<tr><td>${item.product_name}</td><td>${item.quantity}</td></tr>`;
        });
        tbody.innerHTML = html;
    }

    /* =======================================================
       4. SUBMISSION LOGIC
       ======================================================= */
    
    function submitData(mode) {
        if(mode === 'advance' && state.cart.length === 0 && state.existingSubform.length === 0) {
            if(!confirm("The deal has no hardware. Are you sure you want to proceed?")) return;
        }

        setLoading(true, mode);

        let ethVal = document.getElementById("chk_ethernet").checked ? "Yes" : null;
        let poeVal = document.getElementById("chk_poe").checked ? "Yes" : null;

        let subformData = [];
        
        state.existingSubform.forEach(row => {
            subformData.push({ "id": row.id.toString() });
        });

        state.cart.forEach(item => {
            subformData.push({
                "Phone_Selection": { "id": item.product_id },
                "Phone_Qty": item.quantity
            });
        });

        let payload = {
            "id": state.dealId,
            "Ethernet_Cabling": ethVal,
            "PoE_Available": poeVal,
            "Phone_Hardware": subformData
        };

        ZOHO.CRM.API.updateRecord({ Entity: "Deals", APIData: payload, Trigger: ["workflow"] })
        .then(function(data){
            if(mode === 'advance') {
                ZOHO.CRM.BLUEPRINT.proceed({ action: "save", data: {} });
            } else {
                state.cart = []; 
                renderCart();
                loadDealData(); 
                setLoading(false, mode);
                alert("Deal Updated Successfully");
            }
        })
        .catch(function(err){
            alert("Error: " + JSON.stringify(err));
            setLoading(false, mode);
        });
    }

    function enableButtons(enabled) {
        document.getElementById("btnUpdate").disabled = !enabled;
        document.getElementById("btnFinish").disabled = !enabled;
    }

    function setLoading(isLoading, mode) {
        let btn = (mode === 'save') ? document.getElementById("btnUpdate") : document.getElementById("btnFinish");
        if(isLoading) {
            btn.innerText = "Processing...";
            enableButtons(false);
        } else {
            document.getElementById("btnUpdate").innerText = "Update Deal Only";
            document.getElementById("btnFinish").innerText = "Save & Finish";
            enableButtons(true);
        }
    }

</script>

</body>
</html>
